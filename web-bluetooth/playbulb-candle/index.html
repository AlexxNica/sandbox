<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLAYBULB Candle Demo</title>
    <link rel="icon" sizes="192x192" href="../favicon.png">

    <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.0.4/material.green-light_green.min.css">
    <script src="https://storage.googleapis.com/code.getmdl.io/1.0.4/material.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">


    <style>
      body {
        margin: 0 auto;
        background-color: #333;
        max-width: 300px;
        font-family: Roboto;
        color: white;
      }
      canvas {
        margin-top: 20px;
        cursor: crosshair;
      }
      label {
        display: block !important;
        height: 28px !important;
      }
      .off {
        display: none;
      }
      #deviceName {
        font-family: Roboto;
        background: transparent;
        border: 0;
        color: rgb(255, 255, 255);
        font-size: 24px;
        letter-spacing: -.02em;
        text-align: center;
        width: 100%;
        outline: none;
        margin: 12px 0;
      }
      #deviceName:disabled {
        margin-top: 340px;
      }
      #batteryLevel {
        background-color: #222222;
        margin: 12px 0;
        padding: 12px;
        color: rgb(169, 169, 169);
        border-radius: 4px;
      }
      #requestDevice {
        color: white;
        background-color: #4CAF50;
        width: 100%;
        font-weight: bold;
      }
      #buttons {
        background-color: #222222;
        margin: 0 0 12px 0;
        padding: 12px;
        border-radius: 4px;
        letter-spacing: -0.02em;
      }
    </style>
  </head>
  <body>
    <canvas id="colorPicker" width=300 height=300 class="off"></canvas>
    <input id="deviceName" value="PLAYBULB CANDLE DEMO" disabled>
    <button id="requestDevice" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">CONNECT</button>

    <div id="buttons" class="off">
    <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="noEffect">
      <input type="radio" id="noEffect" name="effectSwitch" class="mdl-radio__button" checked/>
      <span class="mdl-radio__label">No Effect</span>
    </label>
    <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="candleEffect">
      <input type="radio" id="candleEffect" name="effectSwitch" class="mdl-radio__button"/>
      <span class="mdl-radio__label">Candle Effect</span>
    </label>
    <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="flashing">
      <input type="radio" id="flashing" name="effectSwitch" class="mdl-radio__button"/>
      <span class="mdl-radio__label">Flashing</span>
    </label>
    <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="pulse">
      <input type="radio" id="pulse" name="effectSwitch" class="mdl-radio__button"/>
      <span class="mdl-radio__label">Pulse</span>
    </label>
    <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="rainbow">
      <input type="radio" id="rainbow" name="effectSwitch" class="mdl-radio__button"/>
      <span class="mdl-radio__label">Rainbow</span>
    </label>
    <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="rainbowFade">
      <input type="radio" id="rainbowFade" name="effectSwitch" class="mdl-radio__button"/>
      <span class="mdl-radio__label">Rainbow Fade</span>
    </label>
    </div>
    <div id="batteryLevel" class="off"></div>
    <script src="playbulbCandle.js"></script>
    <script>
      var currentColor = [255, 255, 255]; // White by default.

      var noEffectSwitch = document.querySelector('#noEffect');
      var candleEffectSwitch = document.querySelector('#candleEffect');
      var flashingSwitch = document.querySelector('#flashing');
      var pulseSwitch = document.querySelector('#pulse');
      var rainbowSwitch = document.querySelector('#rainbow');
      var rainbowFadeSwitch = document.querySelector('#rainbowFade');

      function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
      }
      var img = new Image();
      img.src = 'color-wheel.png';
      img.onload = function() {
        var img = this;
        var canvas = document.getElementById('colorPicker');
        var context = canvas.getContext('2d');

        canvas.width = 300 * devicePixelRatio;
        canvas.height = 300 * devicePixelRatio;
        canvas.style.width = "300px";
        canvas.style.height = "300px";

        canvas.addEventListener('click', pickColor);

        function pickColor(evt) {
          var mousePos = getMousePos(canvas, evt);
          var color = 'FFFFFF';

          var imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          var data = imageData.data;
          var x = mousePos.x * devicePixelRatio;
          var y = mousePos.y * devicePixelRatio;
          var r = data[((canvas.width * y) + x) * 4];
          var g = data[((canvas.width * y) + x) * 4 + 1];
          var b = data[((canvas.width * y) + x) * 4 + 2];

          currentColor = [r,g,b];
          changeColor();
        };

        context.drawImage(img, 0, 0, canvas.width, canvas.height);
      }

function onColorChanged(rgb) {
  if (rgb) {
    console.log('Color changed to ' + rgb);
    currentColor = rgb;
  } else {
    console.log('Color changed');
  }
}

document.querySelector('#requestDevice').addEventListener('click', function() {
  playbulbCandle.requestDevice()
  .then(device => { 
    console.log(device);
    document.querySelector('#requestDevice').classList.add('off');
    document.querySelector('canvas').classList.remove('off');
    document.querySelector('#buttons').classList.remove('off');
    document.querySelector('#batteryLevel').classList.remove('off');
    return playbulbCandle.getDeviceName()
    .then(deviceName => {
      document.querySelector('#deviceName').disabled = false;
      document.querySelector('#deviceName').value = deviceName;
      return playbulbCandle.getBatteryLevel()
      .then(batteryLevel => {
        document.querySelector('#batteryLevel').textContent = 'Battery: ' + batteryLevel + '%';
      });
    });
  })
});

document.querySelector('#deviceName').addEventListener('input', function() {
  var deviceName = this.value;
  playbulbCandle.setDeviceName(deviceName)
  .then(() => {
    console.log('Name changed to ' + deviceName);
  });
});

noEffectSwitch.addEventListener('click', changeColor);
candleEffectSwitch.addEventListener('click', changeColor);
flashingSwitch.addEventListener('click', changeColor);
pulseSwitch.addEventListener('click', changeColor);
rainbowSwitch.addEventListener('click', changeColor);
rainbowFadeSwitch.addEventListener('click', changeColor);

function changeColor() {
  var effect = document.querySelector('[name="effectSwitch"]:checked').id;
  if (!effect.startsWith('rainbow')) {
    var r = currentColor[0];
    var g = currentColor[1];
    var b = currentColor[2];
  }
  switch(effect) {
    case 'noEffect':
      playbulbCandle.setColor(r, g, b).then(onColorChanged);
      break;
    case 'candleEffect':
      playbulbCandle.setCandleEffectColor(r, g, b).then(onColorChanged);
      break;
    case 'flashing':
      playbulbCandle.setFlashingColor(r, g, b).then(onColorChanged);
      break;
    case 'pulse':
      playbulbCandle.setPulseColor(r, g, b).then(onColorChanged);
      break;
    case 'rainbow':
      playbulbCandle.setRainbow().then(onColorChanged);
      break;
    case 'rainbowFade':
      playbulbCandle.setRainbowFade().then(onColorChanged);
      break;
  }
}

    </script>
  </body>
</html>
