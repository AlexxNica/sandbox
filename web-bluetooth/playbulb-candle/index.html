<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLAYBULB Candle Demo</title>
    <link rel="icon" sizes="192x192" href="../favicon.png">

    <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.0.4/material.green-light_green.min.css">
    <script src="https://storage.googleapis.com/code.getmdl.io/1.0.4/material.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">


    <style>
      body {
        margin: 0 auto;
        background-color: #333;
        max-width: 300px;
        font-family: Roboto;
        color: white;
      }
      canvas {
        margin-top: 20px;
        cursor: crosshair;
      }
      .off {
        display: none;
      }
      #deviceName {
        font-family: Roboto;
        background: transparent;
        border: 0;
        color: rgb(255, 255, 255);
        font-size: 24px;
        letter-spacing: -.02em;
        text-align: center;
        width: 100%;
        outline: none;
        margin: 12px 0;
      }
      #deviceName:disabled {
        margin-top: 340px;
      }
      #batteryLevel {
        background-color: #222222;
        margin: 12px 0;
        padding: 12px;
        color: rgb(169, 169, 169);
        border-radius: 4px;
      }
      #requestDevice {
        color: white;
        background-color: #4CAF50;
        width: 100%;
        font-weight: bold;
      }
      #buttons {
        background-color: #222222;
        margin: 0 0 12px 0;
        padding: 12px;
        border-radius: 4px;
        letter-spacing: -0.02em;
      }
    </style>
  </head>
  <body>
    <canvas id="colorPicker" width=300 height=300 class="off"></canvas>
    <input id="deviceName" value="PLAYBULB CANDLE DEMO" disabled>
    <button id="requestDevice" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">CONNECT</button>

    <div id="buttons" class="off">
    <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="candleEffect">
      <input type="checkbox" id="candleEffect" class="mdl-switch__input" />
      <span class="mdl-switch__label">Candle Effect</span>
    </label>

    <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="switch-2">
      <input type="checkbox" id="switch-2" class="mdl-switch__input" />
      <span class="mdl-switch__label">Flashing</span>
    </label>

    <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="switch-3">
      <input type="checkbox" id="switch-3" class="mdl-switch__input" />
      <span class="mdl-switch__label">Pulse</span>
    </label>

    <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="switch-4">
      <input type="checkbox" id="switch-4" class="mdl-switch__input" />
      <span class="mdl-switch__label">Rainbow</span>
    </label>
    </div>
    <div id="batteryLevel" class="off"></div>
    <script src="playbulbCandle.js"></script>
    <script>
      var lastColor = null;

      var candleEffectSwitch = document.querySelector('#candleEffect');

      function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
      }
      var img = new Image();
      img.src = 'color-wheel.png';
      img.onload = function() {
        var img = this;
        var canvas = document.getElementById('colorPicker');
        var context = canvas.getContext('2d');

        canvas.width = 300 * devicePixelRatio;
        canvas.height = 300 * devicePixelRatio;
        canvas.style.width = "300px";
        canvas.style.height = "300px";

        canvas.addEventListener('click', pickColor);

        function pickColor(evt) {
          var mousePos = getMousePos(canvas, evt);
          var color = 'FFFFFF';

          var imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          var data = imageData.data;
          var x = mousePos.x * devicePixelRatio;
          var y = mousePos.y * devicePixelRatio;
          var red = data[((canvas.width * y) + x) * 4];
          var green = data[((canvas.width * y) + x) * 4 + 1];
          var blue = data[((canvas.width * y) + x) * 4 + 2];
          var rgb = red.toString(16) + green.toString(16) + blue.toString(16);

          if (candleEffectSwitch.checked) {
            playbulbCandle.setColorWithEffect(rgb).then(onColorChanged);
          } else {
            playbulbCandle.setColor(rgb).then(onColorChanged);
          }
        };

        context.drawImage(img, 0, 0, canvas.width, canvas.height);
      }

function onColorChanged(rgb) {
  console.log('Color changed to ' + rgb);
  lastColor = rgb;
}

document.querySelector('#requestDevice').addEventListener('click', function() {
  playbulbCandle.requestDevice()
  .then(device => { 
    console.log(device);
    document.querySelector('#requestDevice').classList.add('off');
    document.querySelector('canvas').classList.remove('off');
    document.querySelector('#buttons').classList.remove('off');
    document.querySelector('#batteryLevel').classList.remove('off');
    return playbulbCandle.getDeviceName()
    .then(deviceName => {
      document.querySelector('#deviceName').disabled = false;
      document.querySelector('#deviceName').value = deviceName;
      return playbulbCandle.getBatteryLevel()
      .then(batteryLevel => {
        document.querySelector('#batteryLevel').textContent = 'Battery: ' + batteryLevel + '%';
      });
    });
  })
});

document.querySelector('#deviceName').addEventListener('input', function() {
  var deviceName = this.value;
  playbulbCandle.setDeviceName(deviceName)
  .then(() => {
    console.log('Name changed to ' + deviceName);
  });
});

candleEffectSwitch.addEventListener('click', function() {
  if (!lastColor) {
    return;
  }
  if (this.checked) {
    playbulbCandle.setColorWithEffect(lastColor).then(onColorChanged);
  } else {
    playbulbCandle.setColor(lastColor).then(onColorChanged);
  }
});
/*
document.querySelector('#turnOff').addEventListener('click', function() {
  playbulbCandle.turnOff().then(() => { console.log('Turned off'); })
});

document.querySelector('#colorPicker').addEventListener('change', function() {
  var rgb = this.value.substr(1);
  playbulbCandle.setColor(rgb).then(() => { console.log('Color changed to ' + rgb); })
});

document.querySelector('#colorEffectPicker').addEventListener('change', function() {
  var rgb = this.value.substr(1);
  playbulbCandle.setColorWithEffect(rgb).then(() => { console.log('Color effect changed to ' + rgb); })
});
*/

    </script>
  </body>
</html>
