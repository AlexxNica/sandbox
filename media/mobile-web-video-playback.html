<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#000">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="mobile-web-video-playback.css" rel="stylesheet" type="text/css" />
</head>
<body>
  <div id="videoContainer">
    <video id="video" playsinline muted src="https://storage.googleapis.com/media-session/caminandes/short.mp4#t=101" class="seeking"></video>
    <div id="videoControls">
      <button id="playPauseButton"></button>
      <button id="toggleFullscreenButton"></button>
      <button id="seekForwardButton"></button>
      <button id="seekBackwardButton"></button>
      <div id="videoCurrentTime"></div>
      <div id="videoDuration"></div>
      <div id="videoProgressBar"></div>
    </div>
  </div>
  <p>
    <b>Caminandes 2: Gran Dillama - Blender Animated Short</b><br/>
    <a href="http://www.blender.org">Blender Foundation</a>
  </p>
  <div class="spacer">
    <p>
    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque in gravida velit. Mauris egestas lectus nunc, nec rutrum nisi sagittis posuere. Nunc et aliquam urna, ac pulvinar velit. Donec a vestibulum mi, a venenatis turpis. Phasellus sollicitudin scelerisque lectus. Duis quam dui, venenatis ac quam ut, tincidunt scelerisque ante. Morbi imperdiet lacus vitae justo tempor, quis aliquet neque tincidunt. Donec venenatis urna lectus, vel tincidunt ipsum pretium non. Aliquam leo lorem, eleifend sit amet metus et, finibus dapibus ex. Fusce finibus quam vitae purus accumsan, quis eleifend nisi sagittis. Cras a purus mi. Nam id ullamcorper odio, eget varius dui. Nulla semper ipsum nisi. Nullam commodo mi in malesuada bibendum.
    </p>
    <p>
    Nulla semper eleifend augue, at tristique tellus maximus at. Cras id lacus id nibh dapibus rutrum a vitae risus. Aenean congue elit vitae ex tristique, in bibendum felis porta. Quisque in congue justo. Suspendisse scelerisque metus vitae diam sollicitudin ornare. Phasellus quis aliquam ligula. Pellentesque tempus iaculis odio. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Suspendisse ultrices vitae ante eget maximus. Etiam sagittis tempor commodo. Duis vel tincidunt sem, a blandit risus. Vestibulum bibendum ex et lorem viverra, non cursus urna elementum. Ut semper felis lectus, eu consectetur dui posuere in. Nam sit amet mauris id nisl finibus pulvinar.
    </p>
    <p>
    Sed tincidunt rhoncus dignissim. Phasellus odio purus, ultrices id rhoncus eu, hendrerit at magna. Praesent non orci vitae nisi feugiat fringilla eget vitae ligula. Morbi mollis, lectus quis consectetur imperdiet, lorem lacus luctus nisi, ac efficitur odio dolor id massa. Fusce iaculis mattis mi, ut varius mi rutrum ut. Cras tellus nibh, viverra id mattis quis, facilisis ut dui. Fusce ut viverra lectus.
    </p>
    <p>
    Donec ex tortor, efficitur auctor dictum id, rhoncus nec sapien. Mauris rhoncus fermentum luctus. Sed placerat ante felis. Nulla dapibus sit amet arcu nec tincidunt. In vel vehicula nibh, sit amet ultrices est. Integer risus neque, elementum sit amet commodo ac, pharetra at mauris. Curabitur metus lectus, maximus id ligula finibus, porta tristique elit. Phasellus maximus in orci et tincidunt. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Sed euismod faucibus hendrerit. Donec auctor placerat dui sit amet varius. Praesent non iaculis lorem. Integer vel dolor sagittis lorem vehicula egestas. Nullam imperdiet lacus id lectus bibendum, ac venenatis urna ultrices. Praesent elementum mattis sagittis.
    </p>
    <p>
    Donec sit amet leo convallis, sodales nibh eget, maximus felis. Nullam elementum hendrerit metus. Nulla porttitor ullamcorper mi, ac iaculis diam molestie vitae. Nunc tempor hendrerit ex in tincidunt. Cras tristique, turpis vitae elementum hendrerit, turpis elit vulputate felis, vel ultrices leo diam vitae mi. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec nisi nulla, consectetur eu purus at, eleifend vehicula lacus. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam pretium pharetra neque, eu laoreet magna condimentum et. Etiam facilisis, tortor at consequat efficitur, nulla dui tempor risus, nec sodales enim ligula eu enim. Cras eu finibus lorem.
    </p>
  </div>
  <button id="muteButton" hidden></button>
</body>
<script src="tiny-fullscreen-shim.js"></script>
<script>

  /* Casual stuff there... */

  function showVideoControls() {
    videoControls.classList.add('visible');
  }

  function hideVideoControls() {
    videoControls.classList.remove('visible');
  }

  videoControls.addEventListener('click', function(event) {
    if (videoControls.classList.contains('visible')) {
      hideVideoControls();
    } else {
      showVideoControls();
    }
  });

  document.addEventListener('DOMContentLoaded', function() {
    showVideoControls();
  });

  /* Utils */

  function secondsToTimeCode(seconds) {
    console.log(seconds);
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = Math.floor(seconds % 60);
    return [
      h,
      m > 9 ? m : '0' + m,
      s > 9 ? s : '0' + s,
    ].filter(Boolean).join(':');
  }

  /* Custom controls stuff... */

  video.addEventListener('loadedmetadata', function() {
    console.log('loadedmetadata');
    videoDuration.textContent = secondsToTimeCode(video.duration);
    videoCurrentTime.textContent = secondsToTimeCode(video.currentTime);
    videoProgressBar.style.transform = `scaleX(${video.currentTime / video.duration})`;
    muteButton.classList.toggle('active', video.muted);
  });

  playPauseButton.addEventListener('click', function(event) {
    event.stopPropagation();
    if (video.paused) {
      video.play();
    } else {
      video.pause();
    }
  });

  video.addEventListener('play', function() {
    console.log('play');
    playPauseButton.classList.add('paused');
    hideVideoControls();
  });

  video.addEventListener('pause', function() {
    console.log('pause');
    playPauseButton.classList.remove('paused');
    showVideoControls();
  });

  video.addEventListener('ended', function() {
    console.log('ended');
    playPauseButton.classList.remove('paused');
    video.currentTime = 0;
    showVideoControls();
  });

  document.addEventListener('fullscreenchange', function() {
    toggleFullscreenButton.classList.toggle('active', document.fullscreenElement);
  });

  video.addEventListener('timeupdate', function() {
    console.log('timeupdate');
    videoCurrentTime.textContent = secondsToTimeCode(video.currentTime);
    videoProgressBar.style.transform = `scaleX(${video.currentTime / video.duration})`;
  });

  seekForwardButton.addEventListener('click', function(event) {
    event.stopPropagation();
    seekForward();
  });

  seekBackwardButton.addEventListener('click', function(event) {
    event.stopPropagation();
    seekBackward();
  });
  
  const skipTime = 10;

  function seekForward() {
    video.currentTime = Math.min(video.currentTime + skipTime, video.duration);
  }

  function seekBackward() {
    video.currentTime = Math.max(video.currentTime - skipTime, 0);
  }

  video.addEventListener('seeking', function() {
    console.log('seeking');
    video.classList.add('seeking');
  });

  video.addEventListener('seeked', function() {
    console.log('seeked');
    setTimeout(function() {
      video.classList.remove('seeking');
    }, 200);
  });

</script>
<script>

  /* Here's the interesting stuff... */

  // 1. How to fullscreen programmatically.
  toggleFullscreenButton.addEventListener('click', function(event) {
    event.stopPropagation();
    if (document.fullscreenElement) {
      document.exitFullscreen();
    } else {
      requestFullscreenVideo();
      // 3. Lock screen in landscape when user presses fullscreen no matter the initial orientation.
      lockScreenInLandscape();
    }
  });

  function requestFullscreenVideo() {
    if (videoContainer.requestFullscreen) {
      videoContainer.requestFullscreen();
    } else {
      video.webkitEnterFullscreen();
    }
  }

  // 2. Switch to fullscreen automatically when device is in landscape mode.
  if ('orientation' in screen) {
    screen.orientation.addEventListener('change', function() {
      // Let's automatically request fullscreen if user switches device in landscape mode.
      if (screen.orientation.type.startsWith('landscape')) {
        // Note: It may silently fail in browsers that don't allow requesting
        // fullscreen from the orientation change event.
        // https://github.com/whatwg/fullscreen/commit/e5e96a9da944babf0e246980559cd80a46a300ca
        requestFullscreenVideo();
      } else if (document.fullscreenElement) {
        document.exitFullscreen();
      }
    });
  }

  function lockScreenInLandscape() {
    if (!('orientation' in screen)) {
      return;
    }

    // Let's force landscape mode only if device is in portrait mode and can be held in one hand.
    if (matchMedia('(orientation: portrait) and (max-device-width: 768px)').matches) {
      screen.orientation.lock('landscape').then(function() {
        // When screen is locked in landscape while user holds device in
        // portrait, let's use the Device Orientation API to unlock screen only
        // when it is appropriate to create a perfect and seamless experience.
        listenToDeviceOrientationChanges();
      });
    }
  }

  // 4. Unlock screen automatically based on device orientation
  function listenToDeviceOrientationChanges() {
    if (!('DeviceOrientationEvent' in window)) {
      return;
    }

    var previousDeviceOrientation, currentDeviceOrientation;
    window.addEventListener('deviceorientation', function onDeviceOrientationChange(event) {
      // event.beta represents a front to back motion of the device and
      // event.gamma a left to right motion.
      if (Math.abs(event.gamma) > 10 || Math.abs(event.beta) < 10) {
        previousDeviceOrientation = currentDeviceOrientation;
        currentDeviceOrientation = 'landscape';
        return;
      }
      if (Math.abs(event.gamma) < 10 || Math.abs(event.beta) > 10) {
        previousDeviceOrientation = currentDeviceOrientation;
        // When device is rotated back to portrait, let's unlock screen orientation.
        if (previousDeviceOrientation == 'landscape') {
          screen.orientation.unlock();
          window.removeEventListener('deviceorientation', onDeviceOrientationChange);
        }
      }
    });
  }

</script>
<script>
// Background playback

document.addEventListener('visibilitychange', function() {
  // Pause video when page is hidden.
  if (document.hidden) {
    video.pause();
  }
});

if ('IntersectionObserver' in window) {
  // Show/hide mute button based on video visibility in the page.
  function onIntersection(entries) {
    console.log('onIntersection');
    entries.forEach(function(entry) {
      muteButton.hidden = video.paused || entry.isIntersecting;
    });
  }
  var observer = new IntersectionObserver(onIntersection);
  observer.observe(video);
}

muteButton.addEventListener('click', function() {
  // Mute/unmute video on button click.
  video.muted = !video.muted;
});

video.addEventListener('volumechange', function() {
  muteButton.classList.toggle('active', video.muted);
});
</script>
</body>
</html>
